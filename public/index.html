<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cloud mixes</title>
  <link rel="stylesheet" href="app.css" />
</head>
<body>
  <script src="https://connect.soundcloud.com/sdk/sdk-3.1.2.js"></script>
  <script>
    SC.initialize({
      client_id: '7eff5005846f8ac6bd32d417a55eb5d5'
    });

    function fetchTracks(userName) {
      return SC.resolve(`https://soundcloud.com/${userName}`).then(user => {
        return SC.get(`/users/${user.id}/followings`)
      }).then(users => {
        return Promise.all(users.collection.map(user => {
          return SC.get(`/users/${user.id}/tracks`)
        }))
      }).then(tracks => {
        let allTracks = Array.prototype.concat.apply([], tracks);
        return Promise.resolve(allTracks.sort((a, b) => {
          if (a.created_at == b.created_at) return 0;
          return a.created_at > b.created_at ? -1 : 1;
        }).map(({ id, title, stream_url, artwork_url }) => {
          return { id, title, stream_url, artwork_url };
        }));
      });
    }
  </script>
  <script src="app.js"></script>
  <script>
    var app = Elm.Main.fullscreen();

    app.ports.debug.subscribe(d => console.log(d));

    app.ports.fetchTracks.subscribe(() => {
      console.log('fetching')
      fetchTracks().then(tracks => {
        console.log('sending')
        app.ports.tracks.send(JSON.stringify(tracks));
      });
    });
  </script>
</body>
</html>
